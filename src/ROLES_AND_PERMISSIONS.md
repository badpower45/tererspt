# نظام الأدوار والصلاحيات - AddValues ERP

## نظرة عامة

تم تطوير نظام متكامل للأدوار والصلاحيات يضمن أمان البيانات وتحكم دقيق في الوصول إلى مختلف أجزاء النظام.

---

## الأدوار المتاحة (User Roles)

### 1. مدير النظام (Super Admin)
**`super_admin`**

- **الوصف**: صلاحيات كاملة على جميع أجزاء النظام
- **حالات الاستخدام**: 
  - المدير العام للشركة
  - مدير تقنية المعلومات
  - المسؤول عن إدارة النظام بالكامل

**الصلاحيات الكاملة:**
- ✅ عرض لوحة التحكم والتقارير
- ✅ إدارة المنتجات (إضافة، تعديل، حذف)
- ✅ إدارة المخزون
- ✅ إنشاء وإدارة المبيعات
- ✅ تجاوز الحد الأدنى للأسعار
- ✅ إدارة الشركاء والتبادل التجاري
- ✅ إدارة التركيبات
- ✅ إدارة الفروع
- ✅ عرض التقارير الشاملة
- ✅ إدارة المستخدمين والأدوار
- ✅ الموافقة على طلبات النواقص
- ✅ استخدام نقاط البيع (POS)

**بيانات التسجيل التجريبية:**
```
Username: admin
Password: admin123
```

---

### 2. مدير الفرع (Branch Manager)
**`branch_manager`**

- **الوصف**: إدارة كاملة للفرع المُسند إليه
- **حالات الاستخدام**:
  - مدير فرع المنصورة
  - مدير فرع القاهرة
  - مسؤول عن عمليات الفرع اليومية

**الصلاحيات:**
- ✅ عرض لوحة التحكم الخاصة بالفرع
- ✅ إدارة مخزون الفرع
- ✅ إنشاء مبيعات
- ✅ تجاوز الحد الأدنى للأسعار (ضمن حدود الفرع)
- ✅ إدارة التركيبات في الفرع
- ✅ عرض تقارير الفرع
- ✅ استخدام نقاط البيع
- ❌ إدارة المنتجات الرئيسية
- ❌ إدارة الشركاء
- ❌ إدارة الفروع الأخرى
- ❌ إدارة المستخدمين

**بيانات التسجيل التجريبية:**
```
Username: branch1
Password: branch123
```

---

### 3. مدير المبيعات (Sales Manager)
**`sales_manager`**

- **الوصف**: إدارة عمليات البيع والتسعير
- **حالات الاستخدام**:
  - مدير قسم المبيعات
  - مسؤول استراتيجية التسعير
  - مسؤول علاقات العملاء

**الصلاحيات:**
- ✅ عرض لوحة التحكم
- ✅ إدارة المنتجات (الأسعار والمواصفات)
- ✅ إنشاء مبيعات
- ✅ تجاوز الحد الأدنى للأسعار
- ✅ إدارة الشركاء ومنتجاتهم
- ✅ إدارة التبادل التجاري (Barter)
- ✅ عرض التقارير
- ✅ استخدام نقاط البيع
- ❌ إدارة المخزون
- ❌ إدارة التركيبات
- ❌ إدارة الفروع

**بيانات التسجيل التجريبية:**
```
Username: sales1
Password: sales123
```

---

### 4. مدير المخزون (Inventory Manager)
**`inventory_manager`**

- **الوصف**: إدارة المخزون والمنتجات
- **حالات الاستخدام**:
  - مدير المستودع
  - مسؤول التوريد
  - مسؤول جرد المخزون

**الصلاحيات:**
- ✅ عرض لوحة التحكم
- ✅ إدارة المنتجات (إضافة، تحديث المواصفات)
- ✅ إدارة المخزون الكاملة
- ✅ الموافقة على طلبات النواقص
- ✅ عرض التقارير
- ❌ إنشاء مبيعات
- ❌ تجاوز الأسعار
- ❌ إدارة الشركاء
- ❌ استخدام نقاط البيع

**بيانات التسجيل التجريبية:**
```
Username: inventory1
Password: inventory123
```

---

### 5. الكاشير (Cashier)
**`cashier`**

- **الوصف**: نقطة البيع فقط (POS)
- **حالات الاستخدام**:
  - موظف الكاشير في الفرع
  - موظف نقطة البيع السريعة
  - بائع في المحل

**الصلاحيات:**
- ✅ إنشاء مبيعات عبر POS
- ✅ استخدام نظام POS للبيض
- ❌ عرض لوحة التحكم
- ❌ إدارة المنتجات
- ❌ إدارة المخزون
- ❌ تجاوز الأسعار
- ❌ عرض التقارير

**ملاحظات:**
- يتم فتح شاشة POS تلقائياً عند تسجيل الدخول
- واجهة مبسطة للتركيز على عمليات البيع السريعة
- لا يمكن الوصول إلى صفحات أخرى في النظام

**بيانات التسجيل التجريبية:**
```
Username: cashier1
Password: cashier123
```

---

### 6. مدير الشراكات (Partner Manager)
**`partner_manager`**

- **الوصف**: إدارة الشركاء والتبادل التجاري
- **حالات الاستخدام**:
  - مسؤول علاقات الشركاء
  - مدير المشتريات
  - مسؤول المقارنات والعروض

**الصلاحيات:**
- ✅ عرض لوحة التحكم
- ✅ إدارة الشركاء ومنتجاتهم
- ✅ إدارة التبادل التجاري (Barter)
- ✅ استخدام نظام المقارنات المتقدم
- ✅ عرض التقارير
- ❌ إنشاء مبيعات
- ❌ إدارة المخزون
- ❌ إدارة المنتجات الرئيسية

**بيانات التسجيل التجريبية:**
```
Username: partner1
Password: partner123
```

---

### 7. فني التركيب (Installer)
**`installer`**

- **الوصف**: إدارة عمليات التركيب فقط
- **حالات الاستخدام**:
  - فني التركيب الميداني
  - مشرف فريق التركيب
  - مسؤول المشاريع

**الصلاحيات:**
- ✅ إدارة التركيبات
- ✅ تحديث حالة التركيبات
- ✅ تسجيل المواد المستخدمة
- ❌ عرض لوحة التحكم
- ❌ إدارة المبيعات
- ❌ إدارة المخزون
- ❌ عرض التقارير المالية

---

## مصفوفة الصلاحيات (Permissions Matrix)

| الصلاحية | Super Admin | Branch Manager | Sales Manager | Inventory Manager | Cashier | Partner Manager | Installer |
|---------|------------|---------------|--------------|------------------|---------|----------------|-----------|
| عرض لوحة التحكم | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ❌ |
| إدارة المنتجات | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ | ❌ |
| إدارة المخزون | ✅ | ✅ | ❌ | ✅ | ❌ | ❌ | ❌ |
| إنشاء مبيعات | ✅ | ✅ | ✅ | ❌ | ✅ | ❌ | ❌ |
| تجاوز الأسعار | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| إدارة الشركاء | ✅ | ❌ | ✅ | ❌ | ❌ | ✅ | ❌ |
| التبادل التجاري | ✅ | ❌ | ✅ | ❌ | ❌ | ✅ | ❌ |
| إدارة التركيبات | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ✅ |
| إدارة الفروع | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| عرض التقارير | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ❌ |
| إدارة المستخدمين | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| الموافقة على النواقص | ✅ | ❌ | ❌ | ✅ | ❌ | ❌ | ❌ |
| استخدام POS | ✅ | ✅ | ✅ | ❌ | ✅ | ❌ | ❌ |

---

## الصفحات المتاحة حسب الدور

### مدير النظام (Super Admin)
جميع الصفحات متاحة:
- لوحة التحكم
- المنتجات
- المخزون
- المبيعات
- الشركاء
- منتجات الشراكات
- نظام التبادل
- التركيبات
- الفروع
- نقطة بيع البيض
- الإعدادات

### مدير الفرع (Branch Manager)
- لوحة التحكم
- المخزون
- المبيعات
- التركيبات
- نقطة بيع البيض
- الإعدادات

### مدير المبيعات (Sales Manager)
- لوحة التحكم
- المنتجات
- المبيعات
- الشركاء
- منتجات الشراكات
- نظام التبادل
- نقطة بيع البيض
- الإعدادات

### مدير المخزون (Inventory Manager)
- لوحة التحكم
- المنتجات
- المخزون
- الإعدادات

### الكاشير (Cashier)
- نقطة بيع البيض (فقط)

### مدير الشراكات (Partner Manager)
- لوحة التحكم
- الشركاء
- منتجات الشراكات
- نظام التبادل
- الإعدادات

### فني التركيب (Installer)
- التركيبات (فقط)

---

## تطبيق الصلاحيات في الكود

### 1. حماية الصفحات (Page Protection)

```typescript
// في App.tsx
const canAccessPage = (page: PageType): boolean => {
  if (!user) return false;
  
  const permissionMap: Record<PageType, string> = {
    'dashboard': 'can_view_dashboard',
    'products': 'can_manage_products',
    // ... إلخ
  };

  const requiredPermission = permissionMap[page];
  return hasPermission(user.role, requiredPermission);
};
```

### 2. فلترة القوائم (Menu Filtering)

```typescript
// في Sidebar.tsx
const filteredMenuItems = menuItems.filter(item => {
  if (!item.permission) return true;
  if (!user) return false;
  return hasPermission(user.role, item.permission);
});
```

### 3. التحكم في الأزرار والعناصر

```typescript
// مثال في أي صفحة
import { useAuth } from '../contexts/AuthContext';

function MyComponent() {
  const { user, hasPermission } = useAuth();
  
  return (
    <div>
      {hasPermission('can_override_prices') && (
        <button>تجاوز السعر</button>
      )}
    </div>
  );
}
```

---

## إدارة الجلسة (Session Management)

### تخزين الجلسة
- يتم حفظ بيانات المستخدم في `localStorage` تحت المفتاح `auth_user`
- يتم التحقق من الجلسة عند تحميل التطبيق
- يتم حذف الجلسة عند تسجيل الخروج

### أمان الجلسة
في النظام الحقيقي يجب:
- استخدام JWT Tokens
- تشفير كلمات المرور باستخدام bcrypt
- إضافة مدة انتهاء للجلسة (Session Timeout)
- تسجيل محاولات الدخول الفاشلة
- إضافة Two-Factor Authentication (2FA)

---

## سيناريوهات الاستخدام

### سيناريو 1: الكاشير في الصباح
1. يسجل الدخول: `cashier1 / cashier123`
2. يتم فتح نظام POS للبيض تلقائياً
3. يبدأ بإضافة المنتجات للسلة
4. يكمل عمليات البيع بسرعة
5. لا يمكنه الوصول لأي صفحة أخرى

### سيناريو 2: مدير الفرع
1. يسجل الدخول: `branch1 / branch123`
2. يعرض لوحة التحكم لفرعه
3. يتحقق من مخزون الفرع
4. يراجع المبيعات اليومية
5. يوافق على طلب تركيب جديد
6. لا يمكنه إدارة الفروع الأخرى

### سيناريو 3: مدير الشراكات
1. يسجل الدخول: `partner1 / partner123`
2. يفتح صفحة منتجات الشراكات
3. يفعّل وضع المقارنة
4. يقارن أسعار Inverters من 4 شركاء
5. يختار أفضل عرض
6. يسجل عملية تبادل تجاري جديدة

---

## التطوير المستقبلي

### مرحلة 2: أمان متقدم
- [ ] تطبيق JWT Tokens
- [ ] Password hashing مع bcrypt
- [ ] Session timeout
- [ ] Rate limiting للحماية من Brute Force
- [ ] Audit logs لتتبع الأنشطة

### مرحلة 3: صلاحيات متقدمة
- [ ] صلاحيات مخصصة (Custom Permissions)
- [ ] أدوار متعددة للمستخدم الواحد
- [ ] صلاحيات على مستوى الفرع
- [ ] صلاحيات مؤقتة (Temporary Access)

### مرحلة 4: ميزات إضافية
- [ ] Two-Factor Authentication (2FA)
- [ ] Single Sign-On (SSO)
- [ ] API Keys للتكامل الخارجي
- [ ] Webhooks للإشعارات

---

## الملفات المرتبطة

- `/types/index.ts` - تعريفات الأنواع
- `/lib/permissions.ts` - تعريفات الصلاحيات
- `/contexts/AuthContext.tsx` - Context للمصادقة
- `/components/auth/Login.tsx` - واجهة تسجيل الدخول
- `/App.tsx` - التطبيق الرئيسي مع حماية الصفحات

---

## الدعم والصيانة

للاستفسارات والدعم الفني:
- Email: support@addvalues.com
- Phone: +20123456789

**آخر تحديث:** ديسمبر 2024
**الإصدار:** 1.0.0
